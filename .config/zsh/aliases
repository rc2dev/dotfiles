#
# Shell aliases
#
# Author: Rafael Cavalcanti <https://rafaelc.org/dev>

# List files when cd'ing
cd() { builtin cd "$@" && eval "ls"; }

# Also check command after sudo for alias (see man bash)
alias sudo="sudo "
alias watch="watch "

# Increase verbosity and prompt before overwriting (for rm, prompt
# before removing directory or more than 3 files)
alias cp="cp -vir"
alias mv="mv -vi"
alias rm="rm -vI"
alias ln="ln -vi"
alias chmod="chmod -v"
alias chown="chown -v"
alias mkdir="mkdir -v"

# Human-readable output
alias df="df -h"
alias free="free -h"

# Coloured output
alias grep="grep --color=auto"
alias egrep="egrep --color=auto"
alias fgrep="fgrep --color=auto"
alias rgrep="rgrep --color=auto"
# Accept color escape sequences
alias less="less -R"

# ls
if command -v exa > /dev/null; then
	alias ls="exa --color=auto -aF --group-directories-first"
	alias ll="ls -l --git"
else
	alias ls="ls --color=auto -AF --group-directories-first"
	alias ll="ls -lh"
fi

# History
# Show whole history (like bash) and timestamped
alias history="history -i 0"
# Copy command from history to clipboard
alias hy="fc -ln 0 | fzf | xclip -selection clipboard"

# Shell
alias ..="cd .."
alias c="builtin cd && clear"
alias q="exit"
alias :q="exit"
alias x="exit"
take() {
	if ! mkdir -p "$@"; then
		echo "Retrying with sudo..."
		sudo mkdir -p "$@"
	fi && cd ${@:$#}
}

# Edit
alias e="$EDITOR"
alias ea="ye $ALIASES"
alias eg="vim +'Files $HOME'"
alias ej="ye $JUMPS"
alias ep="vim +Files"
alias et="vim +History"
# Don't use `ye`, since vim-plug operations fail with those variables set.
alias es="ye ~/.config/sxhkd/sxhkdrc"
alias ev="e ~/.vimrc"
alias exp="ye ~/.xprofile"
alias exr="ye $XRESOURCES"
alias ey="ye"
alias ez="ye $ZDOTDIR/.zshrc"
alias ezp="ye ~/.zprofile"

# zoxide: make z interactive when run without arguments
alias z="zi"

# Create a backup of a file
bak() {
	if [[ "$(stat --format '%u' "$1")" == "$UID" ]]; then
		cp "$1"{,.bak}
	else
		sudo cp "$1"{,.bak}
	fi
}

# Easier commands
alias fbl="find . -xtype l"  # Find broken links
alias cx="chmod +x"
alias ex="atool --extract --each --"
alias f="ranger"
alias fn="find . -iname"
alias hs="python3 -m http.server"  # HTTP server
alias reb="reboot || { echo 'Trying sudo...'; sudo reboot; }"
alias s="ssh"
alias y="yadm"

# Shorter xdg-open
# Run fzf if no args.
o() {
	if [[ $# -gt 0 ]]; then
		xdg-open "$@"
		return
	fi

	fzf --height 100% --margin '7%,5%' | xargs -r -d'\n' -P 0 -n 1 xdg-open
}

# Set default options
alias caffeinate="caffeinate --socket $XIDLEHOOK_SOCK"
alias fd="fd $FD_ARGS"
alias spotdl="spotdl --output-format m4a"

# Git
gfr() { git fetch && git reset --hard origin/$(git rev-parse --abbrev-ref HEAD); }
alias glo="git log --all --graph --pretty=format:'%C(bold blue)%h%C(reset) - %C(bold green)(%ar)%C(reset) %C(white)%s%C(reset) %C(dim white)- %an%C(reset)%C(bold yellow)%d%C(reset)%n'"
alias glon="glo --name-only"
alias gw="gh repo view --web"

# yadm
alias ya="yadm add"
alias yau="yadm add -u"
alias yc="yadm commit -v"
alias yc!="yadm commit -v --amend"
alias yca="yadm commit -v -a"
alias ycp="yadm cherry-pick"
alias yco="yadm checkout"
alias yd="yadm diff"
yfr() { yadm fetch && yadm reset --hard origin/$(yadm rev-parse --abbrev-ref HEAD); }
alias yl="yadm pull"
alias ylo="yadm log --all --graph --pretty=format:'%C(bold blue)%h%C(reset) - %C(bold green)(%ar)%C(reset) %C(white)%s%C(reset) %C(dim white)- %an%C(reset)%C(bold yellow)%d%C(reset)%n'"
alias ylon="ylo --name-only"
alias yp="yadm push"
alias ypf="yadm push --force-with-lease"
alias yrb="yadm rebase"
alias yrba="yadm rebase --abort"
alias yrbc="yadm rebase --continue"
alias yrbi="yadm rebase -i"
alias ysh="yadm show"
alias ysw="yadm switch"
alias yst="yadm status"
alias yw="xdg-open https://rafaelc.org/dotfiles >/dev/null 2>&1 & disown"
ye() {
	args=${*:-'+GFiles'}
	GIT_DIR=$HOME/.local/share/yadm/repo.git GIT_WORK_TREE=$HOME vim $args
}

# Notes
alias n="notes"
alias nn="notes name"

# todo.txt
alias t="todo-txt"
alias tad="t add"
alias tdo="t do"
alias te="e $TODO_DIR/todo.txt"

# Use bat if available
command -v bat >/dev/null && alias cat="bat"

# Docker
alias doq="docker run -it --rm -v ~/Downloads:/share"  # Quickly start an interactive container

# mpv and ydl
# Find and stream audio
yta() { mpv --no-keep-open --ytdl-format=bestaudio ytdl://ytsearch:"$*"; }
# Find ans stream video
ytv() { mpv --no-keep-open ytdl://ytsearch:"$*"; }
# List videos from $1 playlist
ytl() { yt-dlp --flat-playlist --dump-json "$1" | jq -r '"https://youtu.be/" + .url'; }
# Download only subtitles
alias yts="yt-dlp --all-subs --skip-download"

# systemctl
alias sc="sudo systemctl"
alias scu="systemctl --user"
alias scdr="sudo systemctl daemon-reload"
alias scudr="sudo systemctl daemon-reload"
alias scr="sudo systemctl restart"
alias scs="systemctl status"

# journalctl
alias jc="journalctl"
alias jcu="journalctl --user-unit"

# Package management
alias aar="sudo apt autoremove -y"
alias afh="apt-file search"
alias ah="apt search"
alias ama="sudo apt-mark auto"
alias amm="sudo apt-mark manual"
alias ai="sudo apt install"
alias ap="sudo apt purge"
alias au="sudo apt update"
alias afu="sudo apt update && sudo apt full-upgrade"
alias aw="apt show"

# Backup vcn
# Use single quotes so date is defined upon use.
alias backup-vcn='ssh vcn sudo tar czf - /boot /etc > pi-vcc_$(date +"%Y-%m-%d_%H-%M-%S").tar.gz'

# Only supported by zsh
if [[ -n "$ZSH_VERSION" ]]; then
	# Global aliases
	alias -g G="| grep"
	alias -g L="| less"
	alias -g LL="|& less"
	alias -g PIPE="|"
	alias -g Y="| xclip -selection clipboard"
	alias -g P="xclip -selection clipboard -out |"
fi

# Termux overrides and additions
if [[ "$HOST" == "localhost" ]]; then
	# Fix aliases that don't work on Busybox
	alias rm="rm -v"
	alias ln="ln -v"
	alias free="free -m"
	unalias grep

	# Backup Termux
	# Use single quotes so date is defined upon use.
	alias backup='tar \
		-C /data/data/com.termux/files \
		-zcf /sdcard/Sync/termux-backup-$(date +"%Y-%m-%d_%H-%M-%S").tar.gz \
		home usr'
fi

# Source jumping aliases
[[ ! -e "$ZDOTDIR/jumps_auto" ]] && gen-jumps
source "$ZDOTDIR/jumps_auto"
