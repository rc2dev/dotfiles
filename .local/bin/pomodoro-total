#!/usr/bin/env bash
#
# Calculate total pomodoros for a specific day on openpomodoro-cli.
#
# Copyright (C) 2023 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail

cat <<END
Note: Day starts/ends at 06:00.

[t]oday (default)
[y]esterday
[b]efore yesterday
yyyy-mm-dd

END

while true; do
  read -r -p "Enter date: " date

  # Default
  if [[ -z "$date" ]]; then
    date="today"
  fi

  if [[ "$date" =~ ^t ]]; then
    date="$(date +%Y-%m-%d)"
  elif [[ "$date" =~ ^y ]]; then
    date="$(date -d yesterday +%Y-%m-%d)"
  elif [[ "$date" =~ ^b ]]; then
    date="$(date -d "today - 2 days" +%Y-%m-%d)"
  fi
  date_next="$(date -d "$date +1 days" +%Y-%m-%d)"

  entries_for_day="$(pomodoro history | \
    awk \
    -v begin=$date"T06:00:00" \
    -v end=$date_next"T06:00:00" \
    '{key=$1}
    key >=begin {p=1}
    key >=end {exit} p'
  )"

  equation="$(sed 's/.*duration=//' <<< "$entries_for_day" | tr '\n' '+') 0"
  total=$(( equation ))
  pomos=$(echo "scale=1; $total / 25" | bc -l)

  yellow=$(tput setaf 3)
  bold=$(tput bold)
  normal=$(tput sgr0)
  echo "$yellow$bold$(date -d "$date" "+%a %Y-%m-%d")$normal"
  echo "$yellow$total min Â· $pomos pomos$normal"
  echo
done
