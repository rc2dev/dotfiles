#!/usr/bin/env bash
#
# dmenu script for pomodoro commands on openpomodoro-cli.
#
# Author: Rafael Cavalcanti <https://rafaelc.org/dev>

set -euo pipefail
readonly dmenu="${DMENU:-dmenu}"

main_menu() {
  local -r prompt="üçÖ Pomodoro"
  local -r options="$(sed -E 's/\s\s//' <<-END
    Start,pomodoro start & amend_menu
    Start ago,start_ago_menu && amend_menu
    Amend,amend_menu
    Cancel,pomodoro cancel
    Finish,pomodoro finish
    Repeat,pomodoro repeat
    Total,$TERMINAL -e sh -c 'pomodoro-total; read _'
END
  )"

  local -r chosen="$(
    cut -d, -f1 <(printf "%s" "$options") |
    $dmenu \
      -p "$prompt" \
      "$@"
  )"
  [[ -z "$chosen" ]] && exit

  local -r cmd="$(grep "$chosen," <(printf "%s" "$options") | cut -d, -f2)"
  eval "$cmd"
}

start_ago_menu() {
  local -a rofi_opts=(-theme-str "window { width: 400px; height: 0; location: center; anchor: center; border: 2px; border-color: @fg-alt; border-radius: 8px; }")

  # Set options specific to launcher
  local launcher_opts
  if [[ $dmenu =~ ^rofi ]]; then
    launcher_opts=("${rofi_opts[@]}")
  else
    launcher_opts=()
  fi

  # Get ago duration
  local -r duration="$($dmenu "${launcher_opts[@]}" -l 0 -p "Duration:")"
  if [[ -z "$duration" ]]; then
    exit 0
  fi

  # Start pomodoro
  pomodoro start --ago "$duration"
}

amend_menu() {
  local -a rofi_opts=(-theme-str "window { width: 400px; height: 0; location: center; anchor: center; border: 2px; border-color: @fg-alt; border-radius: 8px; }")

  # Add current_desc to rofi
  local current_desc="$(pomodoro status --format "%d")"
  local -r current_desc
  rofi_opts+=(-filter "$current_desc")

  # Set options specific to launcher
  local launcher_opts
  if [[ $dmenu =~ ^rofi ]]; then
    launcher_opts=("${rofi_opts[@]}")
  else
    launcher_opts=()
  fi

  # Get new description
  local desc="$($dmenu "${launcher_opts[@]}" -l 0 -p "Amend pomo:")"
  readonly desc
  if [[ -z "$desc" ]]; then
    exit 0
  fi

  # Set new description
  if pomodoro amend "$desc"; then
    notify-send -i tomato "Pomodoro" "Description set."
  else
    notify-send -i tomato "Pomodoro" -u critical "Description not set."
  fi
}

main_menu "$@"
