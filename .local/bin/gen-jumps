#!/usr/bin/env bash
#
# This generates shell aliases and ranger mappings for jumping directories. A
# configuration file defines the paths and the bindings.
#
# Copyright (C) 2022 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail

readonly script_name="$(basename "$0")"
readonly src="$HOME/.config/jumps.conf"
readonly out_dir="$HOME/.cache/$script_name"

# Make output dir
mkdir -p "$out_dir"

# Initialize output files
printf "# This file is automatically generated by %s.\n\n" "$script_name" | tee "$out_dir/shell" "$out_dir/ranger" >/dev/null

# Below, we do a few things:
# 1. Use envsubst to replace env vars with their actual value. Needed for ranger.
# 2. Use awk's regex to skip lines starting with # (comments) and empty lines.
# 3. Check if each directory exists, don't generate the mapping if they don't.
envsubst < "$src" | awk \
  -F' ' \
  -v out_shell="$out_dir/shell" \
  -v out_ranger="$out_dir/ranger" \
  '! /^(#|\s*$)/ {
  if (system("[ -d " $2 " ]") == 0) {
    printf "alias z%s=\"cd %s\"\n", $1, $2 >> out_shell
    printf "map g%s cd %s\n", $1, $2 >> out_ranger
  }}'

