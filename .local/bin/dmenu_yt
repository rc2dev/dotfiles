#!/usr/bin/env bash
#
# dmenu script for playing user's yt playlists on shuffle.
#
# Author: Rafael Cavalcanti <https://rafaelc.org/dev>

readonly yt_channel="UCHMpAR9vVyImG570uZqElPg"
readonly pls_cache="$HOME/.cache/dmenu_yt/playlists.json"
# User created playlists
readonly pls_url="https://www.youtube.com/channel/$yt_channel/playlists?view=1"


# Don't wait for getting playlists from remote server
cache_pls() {
  pls_json="$(yt-dlp --flat-playlist --dump-json "$pls_url")"
  # Add missing "Watch Later"
  pls_json+=' {"url": "https://www.youtube.com/playlist?list=WL", "title": "Watch Later"}'

  mkdir -p "$(dirname "$pls_cache")"
  echo "$pls_json" > "$pls_cache"
}

if [[ ! -e "$pls_cache" ]]; then
  cache_pls
else
  cache_pls &
fi

# Read playlist titles but sort "Watch Later" first
readarray -t pls_titles < <(jq -r 'select(.title != "Watch Later") | .title' < "$pls_cache")
readonly chosen="$( (printf "Watch Later\n"; (printf "%s\n" "${pls_titles[@]}" | sort)) | dmenu -p "yt playlists:" "$@")"

[[ -z "$chosen" ]] && exit
readonly url="$(jq -r "select(.title==\"$chosen\") | .url" < "$pls_cache")"

mpv --shuffle "$url"

