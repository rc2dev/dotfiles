#!/usr/bin/env bash
#
# Copyright (C) 2020-2021 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

readonly sep="  Â·  "

truncate() {
  local -r max_len=20
  local -r str="$*"

  if [[ ${#str} -gt $max_len ]]; then
    local trunc="${str::(( max_len - 3 ))}"
    trunc="$(sed -e 's/[[:space:]]*$//' <<< "$trunc")" # Trim trailing space
    echo "$trunc..."
  else
    echo "$str"
  fi
}

bar_vol() {
  if [[ "$(pamixer --get-mute)" == "1" ]]; then
    local -r icon="ğŸ”‡"
  else
    local -r icon="ğŸ”Š"
  fi

  printf "%s %3d%%" "${icon}" "$(pamixer --get-volume | cut -f 1 -d ' ')"
}

bar_player() {
  local -r status="$(playerctl status 2>/dev/null)"

  [[ "$status" =~ (Playing|Paused) ]] || return 0

  case $status in
    Playing) local -r icon=ï‹;;
    Paused) local -r icon=ïŒ;;
  esac

  # Calling metadata...
  #   - with --format: prevents mixing multiple players
  #   - only once: prevents racing conditions (mixing prev and next song)
  local -a metadata
  local -r NL=$'\n'
  mapfile -t metadata < <(playerctl metadata --format "{{ artist }}$NL{{ title }}")

  # Truncate long metadata
  local -r artist="$(truncate "${metadata[0]}")"
  local -r title="$(truncate "${metadata[1]}")"

  echo "${icon} ${artist:+$artist -} ${title}"
}

bar_time() {
  echo "ï³ $(date +"%a, %d/%m %R")"
}

bar_mem() {
  echo "ï‚… $(free -h | awk '/^Mem:/ {print $3}')"
}

bar_temp() {
  echo "ï‹‰ $(sensors | awk '/^Package/ {print substr($4, 2)}')"
}

bar_battery() {
  local -r battery="/sys/class/power_supply/BAT0"
  if [[ ! -e "$battery" ]]; then
    return
  fi

  local -r notify_id=102
  local -r low_level=20
  local -r status="$(cat "$battery/status")"
  local -r level="$(cat "$battery/capacity")"

  local icon
  case "$status" in
    "Full") icon="ï‰€" ;;
    "Discharging")
      if [[ $level -gt 50 ]]; then icon="ï‰"
      elif [[ $level -gt 15 ]]; then icon="ï‰‚"
      else icon="ï‰„"
      fi
      ;;
    "Charging") icon="âš¡" ;;
    "Not charging") icon="ğŸ›‘" ;;
    "Unknown") icon="ï„¨" ;;
  esac

  # Low battery notification
  if [[ "$status" == "Discharging" && $level -lt $low_level ]]; then
    dunstify --replace "$notify_id" --urgency=critical "Battery low" "Battery level: $level%."
  else
    dunstify --close "$notify_id"
  fi

  echo "$icon $level%"
}

declare -ar elements=(
  "$(bar_player)"
  "$(bar_battery)"
  "$(bar_temp)"
  "$(bar_mem)"
  "$(bar_time)"
)

# Generate output string
output="$(printf "\t%s" "${elements[@]}")"
# Remove separator from beginning and duplicated
output="$(sed -E 's/^\t*//; s/\t+/\t/g' <<< ${output})"
# Place chosen separator
output="$(sed "s/\t/$sep/g" <<< ${output})"
# Increase spacing for non-mono fonts
output="${output// /  }"

xsetroot -name "$output"

