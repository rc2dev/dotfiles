#!/usr/bin/env bash
#
# Commands to update my systems.
#
# Copyright (C) 2017-2023 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail
readonly submodules_host="x220"

main() {
	declare -i step=0

	update_dotfiles
	update_git_repos
	update_distro
	update_flatpaks
	update_pipx_packages
	update_nvim_plugins
	update_tmux_plugins
	update_zsh_plugins
	update_submodules

	log "Concluído."
}

log() {
	printf "%s\n" "$*" 1>&2
}

log_step() {
	((step++)) || true

	log
	log "[ $step ] $*"
}

has_command() {
	command -v "$1" > /dev/null
}

is_termux() {
	echo "${PREFIX:-}" | grep -q "com.termux"
}

update_distro() {
	if is_termux; then
		log_step "Atualizando pacotes do Termux..."
		pkg upgrade

	elif has_command apt; then
		log_step "Atualizando pacotes do APT..."
		sudo apt update && sudo apt upgrade

	elif has_command dnf; then
		log_step "Atualizando pacotes do DNF..."
		# Allow script to continue if user rejects operation
		sudo dnf upgrade --refresh || if (( $? == 1 )); then return 0; fi

	else
		log "Atualização de pacotes não disponível para a sua distro."
	fi
}

update_flatpaks() {
	has_command flatpak || return 0

	log_step "Atualizando flatpaks..."
	# Allow script to continue if user rejects operation
	sudo flatpak update || if (( $? == 1 )); then return 0; fi
}

update_dotfiles() {
	has_command dotfiles || return 0

	log_step "Atualizando dotfiles..."
	dotfiles pull
}

update_submodules() {
	has_command dotfiles || return 0

	[[ "$(hostname)" == "$submodules_host" ]] || return 0

	log_step "Atualizando submódulos dos dotfiles..."
	dotfiles submodule update --remote
}

update_nvim_plugins() {
	has_command nvim || return 0

	log_step "Atualizando plugins do Neovim..."
	nvim +PlugClean! +PlugUpdate +qa!
}

update_tmux_plugins() {
	has_command tmux || return 0

	log_step "Atualizando plugins do tmux..."
	~/.config/tmux/plugins/tpm/bin/update_plugins all
}

update_git_repos() {
	log_step "Atualizando repos em ~/..."

	# Don't output the glob if no directory found.
	shopt -s nullglob

	for i in \
		$HOME/.local/opt/*/.git \
		$HOME/.local/share/themes/*/.git \
		$HOME/.local/share/icons/*/.git; do
		# Don't update repo if it's a submodule
		if [[ ! -d "$i" ]]; then
			continue
		fi

		( echo $i; cd $i/..; git pull; )
	done
}

update_zsh_plugins() {
	has_command zsh || return 0

	log_step "Atualizando plugins do zsh..."
	zsh -ic "antidote update --bundles" || true
}

update_pipx_packages() {
	has_command pipx || return 0

	log_step "Atualizando pacotes do pipx..."
	pipx upgrade-all
}

main "$@"
