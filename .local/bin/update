#!/usr/bin/env bash
#
# Commands to update my systems.
#
# Copyright (C) 2017-2023 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail
readonly dev_host="x220"

# Whiptail theme
export NEWT_COLORS="
    root=white,black
    border=black,lightgray
    window=lightgray,lightgray
    title=black,lightgray
    button=black,cyan
    actbutton=white,cyan
    compactbutton=black,lightgray
    checkbox=black,lightgray
    actcheckbox=lightgray,cyan
    entry=black,lightgray
    disentry=gray,lightgray
    label=black,lightgray
    emptyscale=,gray
    fullscale=,cyan
    helpline=white,black
    roottext=lightgrey,black
"

declare -a choices=(
	distro        " " ON
	flatpaks      " " ON
	pipx_packages " " ON

	dotfiles      " " ON
	submodules    " " $(if [[ "$(hostname)" == "$dev_host" ]]; then echo ON; else echo OFF; fi)

	nvim_plugins  " " ON
	tmux_plugins  " " ON
	zsh_plugins   " " ON
)

main() {
	# Whiptail
	local -r title="update"
	local -r prompt="Choose what to update:"
	local -r chosen="$(whiptail --title "$title" --checklist "$prompt" 15 50 8 "${choices[@]}" 3>&2 2>&1 1>&3-)"

	# Run selected updates
	for cmd in $chosen; do
		eval "update_$cmd"
	done
}

log() {
	local -r bold=$(tput bold)
	local -r underline=$(tput smul)
	local -r green=$(tput setaf 2)
	local -r normal=$(tput sgr0)
	printf "\n$bold$green➝ [update] %s$normal\n" "$*" 1>&2
}

has_command() {
	command -v "$1" > /dev/null
}

is_termux() {
	[[ -n "${TERMUX_VERSION:-}" ]]
}

update_distro() {
	if is_termux; then
		log "Atualizando pacotes do Termux..."
		pkg upgrade

	elif has_command apt; then
		log "Atualizando pacotes do APT..."
		sudo apt update && sudo apt upgrade

	elif has_command dnf; then
		log "Atualizando pacotes do DNF..."
		sudo dnf upgrade --refresh

	else
		log "Atualização de pacotes não disponível para a sua distro."
	fi
}

update_flatpaks() {
	if ! has_command flatpak; then
		log "Skipping flatpak update: not installed."
		return 0
	fi

	log "Atualizando flatpaks..."
	flatpak update
}

update_dotfiles() {
	if ! has_command dotfiles; then
		log "Skipping dotfiles update: not installed."
		return 0
	fi

	log "Atualizando dotfiles..."
	dotfiles pull
}

update_submodules() {
	if ! has_command dotfiles; then
		log "Skipping submodules update: dotfiles not installed."
		return 0
	fi

	log "Atualizando submódulos dos dotfiles..."
	dotfiles submodule update --remote
}

update_nvim_plugins() {
	if ! has_command nvim; then
		log "Skipping nvim plugins update: not installed."
		return 0
	fi

	log "Atualizando plugins do Neovim..."
	nvim +"lua if vim.g.lazy_did_setup then require('lazy').update({wait=true}) end" +qa
}

update_tmux_plugins() {
	if ! has_command tmux; then
		log "Skipping tmux plugins update: not installed."
		return 0
	fi

	# Return if no plugin is installed, to avoid error message
	if [[ $(find ~/.config/tmux/plugins -maxdepth 1 -type d | wc -l) -le 1 ]]; then
		log "Skipping tmux plugins update: no plugin installed."
		return 0
	fi

	log "Atualizando plugins do tmux..."
	~/.config/tmux/plugins/tpm/bin/update_plugins all
}

update_zsh_plugins() {
	if ! has_command zsh; then
		log "Skipping zsh plugins update: zsh not installed."
		return 0
	fi

	log "Atualizando plugins do zsh..."
	zsh "$ZDOTDIR/.antidote/antidote" update --bundles
}

update_pipx_packages() {
	if ! has_command pipx; then
		log "Skipping pipx packages update: pipx not installed."
		return 0
	fi

	log "Atualizando pacotes do pipx..."
	pipx upgrade-all
}

main "$@"
