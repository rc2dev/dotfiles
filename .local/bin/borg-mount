#!/usr/bin/env bash
#
# Mount Borg archives with ease.
#
# Copyright (C) 2019-2022 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail

readonly script_name="$(basename "$0")"
IFS=$'\n'

if ! command -v borg >/dev/null; then
	printf "Please install Borg.\n"
	exit 1
fi

if [[ $# -ne 1 ]]; then
	cat <<-END
		Usage: $script_name repos_dir

		repos_dir: The directory parent to your repositories
	END
	exit 1
fi

readonly repos_dir="$1"
if [ ! -d "${repos_dir}" ]; then
	printf "Given directory doesn't exist.\n"
	exit 1
fi

if [[ -z "${BORG_PASSPHRASE:-}" && -z "${BORG_PASSCOMMAND:-}" && -z "${BORG_PASSPHRASE_FD:-}" ]]; then
	read -s -p "Enter passphrase: " BORG_PASSPHRASE
	printf "\n"
	export BORG_PASSPHRASE
fi

printf "Select repo:\n"
repos=$(find "${repos_dir}" -maxdepth 1 -mindepth 1 -type d -printf "%f\n")
select repo in ${repos}; do
	case ${repo} in
		"") printf "Invalid repo.\n" ;;
		*) printf "You selected %s.\n\n" "${repo}" && break ;;
	esac
done

printf "Select archive:\n"
if ! archives=$(borg list --short "${repos_dir}/${repo}"); then
	printf "Error listing archives.\n"
	exit 1
fi
select archive in ${archives}; do
	case ${archive} in
		"") printf "Invalid archive.\n" ;;
		*) printf "You selected %s.\n\n" "${archive}" && break ;;
	esac
done

mnt_dir=$(mktemp -d)
printf "Mounting archive at %s...\n" "${mnt_dir}"
if ! borg mount "${repos_dir}/${repo}::${archive}" "${mnt_dir}"; then
	printf "Error mounting archive.\n"
	exit 1
fi

if [ -n "${DISPLAY:-}" ]; then
	printf "Opening in file manager...\n\n"
	xdg-open "${mnt_dir}" >/dev/null 2>&1
fi

read -p "Press enter to umount. "
while ! fusermount -u "${mnt_dir}"; do
	read -p "Press enter to try again. "
done
rmdir "$mnt_dir"
