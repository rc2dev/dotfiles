#!/usr/bin/env bash
#
# dmenu script for playing TV stations.
#
# Features:
# - History: recently watched and most watched.
# - Favorite streams.
# - Automatically refresh (re-download) playlists.
#
# Copyright (C) 2022 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail
readonly cache_dir="$HOME/.cache/dmenu_tv"
readonly config_dir="$HOME/.config/dmenu_tv"
readonly playlists_conf="$config_dir/playlists.conf"
readonly playlists_dir="$cache_dir/playlists"
readonly history_file="$cache_dir/history"
readonly favorites_file="$config_dir/favorites"
readonly history_max_store=10000
readonly most_watched_max=40
readonly recent_max=10
readonly -a dmenu_opts=(-g 5 -l 8)

if [[ ! -e "$playlists_conf" ]]; then
  notify_send "dmenu_tv" "Configure playlists first."
  exit 0
fi

# Make sure files and directories exist
mkdir -p "$cache_dir"
mkdir -p "$playlists_dir"
touch "$history_file"
touch "$favorites_file"

# Check if downloading streams is needed
if [[ "$(find "$playlists_dir" -mtime -1 -type f -iname "*.m3u" | wc -l)" == "0" ]]; then
  download_msg="Stream files are old. Downloading again..."
elif [[ "$playlists_conf" -nt "$playlists_dir" ]]; then
  download_msg="Playlists configuration was modified. Downloading again..."
fi

# Download streams if needed
if [[ -n "${download_msg:-}" ]]; then
  notify-send "dmenu_tv" "$download_msg"

  rm -f "$playlists_dir"/*
  while read -r url; do
    (cd "$playlists_dir"; curl -O "$url")
  done <<< "$(sed '/^#/d; /^\s*$/d' "$playlists_conf")"
fi

# Get streams
readonly all_streams="$(grep -h '^#EXTINF' $playlists_dir/* | sed 's/^#.*",//' | sort | uniq)"
readonly most_watched="$(sort "$history_file" | uniq -c | sort -nr | cut -c 9- | head -$most_watched_max)"
readonly recent="$(uniq "$history_file" | head -n $recent_max)"
readonly last="$(head -n 1 "$history_file")"
readonly favorites="$(cat "$favorites_file")"

# Main menu
readonly main_menu="
  $(if ! grep -qF "$last" <<< "$favorites"; then echo "Add to favorites: $last"; fi)
  MOST WATCHED
  FAVORITES
  RECENT
  ------------- ALL --------------
  $all_streams
"

# Choose stream
while true; do
  chosen="$(echo "$main_menu" | sed -E 's/^\s+//;/^\s*$/d' | dmenu -p "tv:" "${dmenu_opts[@]}")"

  # Invalid options
  if [[ -z "$chosen" || "$chosen" =~ ^--- ]]; then
    exit 0
  fi

  # Option: sub-menus
  if [[ "$chosen" == "MOST WATCHED" ]]; then
    chosen="$(printf "..\n%s" "$most_watched" | dmenu -p "most watched:" "${dmenu_opts[@]}")"
  elif [[ "$chosen" == "RECENT" ]]; then
    chosen="$(printf "..\n%s" "$recent" | dmenu -p "recent:" "${dmenu_opts[@]}")"
  elif [[ "$chosen" == "FAVORITES" ]]; then
    chosen="$(printf "..\n%s" "$favorites" | dmenu -p "favorites:" "${dmenu_opts[@]}")"
  fi

  # Option: Add to favorites
  if [[ "$chosen" =~ ^Add ]]; then
    echo "$last" >> "$favorites_file"
    sort "$favorites_file" -o "$favorites_file"
    exit 0
  fi

  if [[ "$chosen" != ".." ]]; then
    break
  fi
done

# Save to history
readonly history_text="$(echo "$chosen"; head -$history_max_store "$history_file")"
echo "$history_text" > "$history_file"

readonly url="$(grep -h -A1 -F "$chosen" "$playlists_dir"/* | tail -n +2)"
mpv --no-resume-playback "$url"
