#!/usr/bin/env bash
#
# dmenu script for playing TV stations.
#
# Features:
# - Most watched streams (history).
# - Automatically refresh (re-download) playlists.
#
# Copyright (C) 2022 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail
readonly cache_dir="$HOME/.cache/dmenu_tv"
readonly playlists_conf="$HOME/.config/dmenu_tv/playlists.conf"
readonly playlists_dir="$cache_dir/playlists"
readonly history_file="$cache_dir/history"
readonly history_max_store=10000
readonly most_watched_max=100
readonly recent_max=5

if [[ ! -e "$playlists_conf" ]]; then
  notify_send "dmenu_tv" "Configure playlists first."
  exit 0
fi

# Make sure history file and directories exist
mkdir -p "$cache_dir"
mkdir -p "$playlists_dir"
touch "$history_file"

# Check if downloading streams is needed
if [[ "$(find "$playlists_dir" -mtime -1 -type f -iname "*.m3u" | wc -l)" == "0" ]]; then
  download_msg="Stream files are old. Downloading again..."
elif [[ "$playlists_conf" -nt "$playlists_dir" ]]; then
  download_msg="Playlists configuration was modified. Downloading again..."
fi

# Download streams if needed
if [[ -n "${download_msg:-}" ]]; then
  notify-send "dmenu_tv" "$download_msg"

  rm -f "$playlists_dir"/*
  while read -r url; do
    (cd "$playlists_dir"; curl -O "$url")
  done <<< "$(sed '/^#/d; /^\s*$/d' "$playlists_conf")"
fi

# Build options
readonly all_streams="$(grep -h '^#EXTINF' $playlists_dir/* | sed 's/^#.*",//' | sort | uniq)"
readonly most_watched="$(sort "$history_file" | uniq -c | sort -nr | cut -c 9- | head -$most_watched_max)"
readonly recent="$(uniq "$history_file" | head -n $recent_max)"
readonly menu="
  ------- RECENT -------
  $recent
  ---- MOST WATCHED ----
  $most_watched
  ------- STREAMS -------
  $all_streams
"

# Choose stream
readonly chosen="$(echo "$menu" | sed -E 's/^\s+//;/^\s*$/d' | dmenu -p "tv:" -g 6 -l 8)"
if [[ -z "$chosen" || "$chosen" =~ ^--- ]]; then
  exit 0
fi

# Save to history
readonly history_text="$(echo "$chosen"; head -$history_max_store "$history_file")"
echo "$history_text" > "$history_file"

readonly url="$(grep -h -A1 -F "$chosen" "$playlists_dir"/* | tail -n +2)"
mpv --no-resume-playback "$url"
