#!/usr/bin/env bash
#
# dmenu script for playing radio stations.
#
# Copyright (C) 2022-2023 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail

readonly dmenu="${DMENU:-dmenu}"
readonly dmenu_prompt="Radio"
readonly notify_id=103
readonly notify_time=10000
readonly notify_icon="radio"
readonly unit_name="dmenu_radio_player"
readonly last_file="${XDG_CACHE_HOME:-$HOME/.cache}/dmenu_radio_last"
readonly section_prefix="➤"


if [[ $dmenu =~ ^dmenu.* ]]; then
  launcher_opts=(-l 9)
else
  launcher_opts=()
fi

readonly streams="$(sed -E 's/^\s+//' <<-END
  $section_prefix 🇪🇸 MUSIC
  Cadena 100,https://cadena100-cope.flumotion.com/chunks.m3u8
  Cadena Dial,https://playerservices.streamtheworld.com/api/livestream-redirect/CADENADIAL.mp3
  LOS40,https://playerservices.streamtheworld.com/api/livestream-redirect/Los40.mp3
  Radio 3,https://rtvelivestream.akamaized.net/rtvesec/rne/rne_r3_main.m3u8
  Radio Clásica,https://rtvelivestream.akamaized.net/rtvesec/rne/rne_r2_main.m3u8
  Radiolé,https://playerservices.streamtheworld.com/api/livestream-redirect/RADIOLE.mp3

  $section_prefix 🇪🇸 GENERALISTAS
  COPE,https://flucast24-h-cloud.flumotion.com/cope/net1.mp3
  Cadena SER,https://playerservices.streamtheworld.com/api/livestream-redirect/CADENASER.mp3
  Cadena SER Valencia,https://playerservices.streamtheworld.com/api/livestream-redirect/SER_VALENCIA.mp3
  Radio María,http://dreamsiteradiocp.com:8060/;stream.mp3
  RNE1,https://rtvelivestream.akamaized.net/rtvesec/rne/rne_r1_main.m3u8
  RNE1 C. Valenciana,https://dispatcher.rndfnk.com/crtve/rne1/val/mp3/high
  RNE Radio 5,https://rtvelivestream.akamaized.net/rtvesec/rne/rne_r5_madrid_main.m3u8

  $section_prefix SELECTION
  Classic FM,http://vis.media-ice.musicradio.com/ClassicFMMP3
  France Musique Classique Plus,http://direct.francemusique.fr/live/francemusiqueclassiqueplus-hifi.mp3
  France Musique La Jazz,http://direct.francemusique.fr/live/francemusiquelajazz-hifi.mp3
  Folk Radio UK,http://streaming.radionomy.com/FolkRadioUK
  Radio Swiss Classic,http://stream.srg-ssr.ch/m/rsc_de/aacp_96
  Radio Swiss Jazz,http://stream.srg-ssr.ch/m/rsj/aacp_96
  Radio X London,http://media-sov.musicradio.com:80/RadioXLondonMP3
  San Diego Jazz 88.3,http://listen.jazz88.org/ksds.mp3

  $section_prefix OTHER
  Lofi (YouTube),https://www.youtube.com/watch?v=jfKfPfyJRdk
END
)"

if systemctl --user is-active --quiet "$unit_name"; then
  state="⏹️ Stop: $(systemctl --user show dmenu_radio_player | grep Description= | cut -d= -f2-)"
elif [[ -f "$last_file" ]]; then
  state="▶️ Play last: $(cat "$last_file")"
else
  state=
fi

readonly menu="$(sed -E 's/^\s+//' <<-END
  🎲 Random
  $state

  $streams
END
)"

chosen="$(sed -E 's/,.*$//' <<< "$menu" | $dmenu -p "$dmenu_prompt" "${launcher_opts[@]}")"

# Exit if nothing chosen.
if [[ -z "$chosen" ]] || [[ "$chosen" =~ ^$section_prefix ]]; then
  exit
fi

# Chosen value is valid. Stop if playing.
systemctl --user stop "$unit_name" || true
if [[ "$chosen" =~ Stop ]]; then
  exit
fi

# If chosen value is special, reassign it.
if [[ "$chosen" =~ Play\ last ]]; then
  chosen="$(cat "$last_file")"
elif [[ "$chosen" =~ Random ]]; then
  readonly names_only="$(sed -E 's/,.*$//;/^\s*\W/d;/^\s*$/d' <<< "$streams")"
  chosen="$(shuf -n 1 <<< "$names_only")"
fi

# We should have a stream name now. Record it and get the url.
printf "%s" "$chosen" > "$last_file"
readonly url="$(printf "%s" "$streams" | grep -m 1 "$chosen" | cut -d, -f 2-)"

# Notify and play.
dunstify -r $notify_id -t "$notify_time" -i "$notify_icon" "Playing" "<i>$chosen</i>"
systemd-run \
  --user \
  --collect \
  --unit "$unit_name" \
  --description "$chosen" \
  mpv --no-video --no-resume-playback $url  # Don't double quote as url can include mpv options.
