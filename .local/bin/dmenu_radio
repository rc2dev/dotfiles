#!/usr/bin/env bash
#
# dmenu script for playing radio stations.
#
# Copyright (C) 2022 Rafael Cavalcanti <https://rafaelc.org/dev>
# Licensed under GPLv3

set -euo pipefail

readonly notify_id=103
readonly notify_time=10000
readonly notify_icon="radio"
readonly unit_name="dmenu_radio_player"


if systemctl --user is-active --quiet "$unit_name"; then
  current="$(systemctl --user show dmenu_radio_player | grep Description= | cut -d= -f2-)"
else
  current="not playing"
fi

declare -r streams="\
  ‚èπ Stop: $current
  üé≤ Random
  -------- MUSIC --------
  Cadena 100,https://cadena100-cope.flumotion.com/chunks.m3u8
  Cadena Dial,https://playerservices.streamtheworld.com/api/livestream-redirect/CADENADIAL.mp3
  Canal Fiesta Radio,https://cdnlive.shooowit.net/rtvalive/smil:channel5.smil/master.m3u8
  LOS40,https://playerservices.streamtheworld.com/api/livestream-redirect/Los40.mp3
  Lofi,https://www.youtube.com/watch?v=jfKfPfyJRdk
  Radio 3,https://rtvelivestream.akamaized.net/segments/rne/rne_r3_main.m3u8
  Radiol√©,https://playerservices.streamtheworld.com/api/livestream-redirect/RADIOLE.mp3
  ----- GENERALISTAS -----
  COPE,https://flucast-m04-06.flumotion.com/cope/net1.mp3
  Cadena SER,https://playerservices.streamtheworld.com/api/livestream-redirect/CADENASER.mp3
  Cadena SER Valencia,https://playerservices.streamtheworld.com/api/livestream-redirect/SER_VALENCIA.mp3
  Radio Mar√≠a,http://dreamsiteradiocp.com:8060/;stream.mp3
  RNE1,https://rtvelivestream.akamaized.net/segments/rne/rne_r1_main.m3u8
  RNE1 C. Valenciana,https://crtve-rne1-val.cast.addradio.de/crtve/rne1/val/mp3/high
  RNE Radio 5,https://rtvelivestream.akamaized.net/segments/rne/rne_r5_madrid_main.m3u8
  ------ SELECTION ------
  ArtSound FM 92.7,http://119.15.96.188/stream2.mp3
  Classic FM,http://vis.media-ice.musicradio.com/ClassicFMMP3
  CDNX 1 - Classic & New Indie Alt,http://svr1.msmn.co:8136
  CDNX 2 - New & Upfront Indie Alt,http://msmn.co:8118
  EuropaRadioJazz - 88.3 Smooth Jazz HD,http://109.74.196.76:8021/stream
  France Culture Live,http://direct.franceculture.fr/live/franceculture-midfi.mp3
  France Musique Classique Plus,http://direct.francemusique.fr/live/francemusiqueclassiqueplus-hifi.mp3
  France Musique La Contemporaine,http://direct.francemusique.fr/live/francemusiquelacontemporaine-hifi.mp3
  France Musique La Jazz,http://direct.francemusique.fr/live/francemusiquelajazz-hifi.mp3
  Folk Radio UK,http://streaming.radionomy.com/FolkRadioUK
  Ibiza Sonica,http://95.211.3.65:8136/listen.pls?sid=1
  KDHX 88.1 FM St. Louis,http://kdhx-ice.streamguys1.com:80/live
  KEXP 90.3 FM Seattle,http://live-aacplus-64.kexp.org/kexp64.aac
  KMHD Portland FM 89.1 - Jazz,http://stream1.opb.org/kmhd.mp3
  NTS Live International,http://stream-relay-geo.ntslive.net/stream2
  Radio 24 Il Sole 24 Ore,http://shoutcast.radio24.it:8000/
  Radio Paradise,http://stream-dc1.radioparadise.com/rp_192m.ogg
  Radio Reload,http://onair15.xdevel.com:7012/1
  Radio Swiss Classic,http://stream.srg-ssr.ch/m/rsc_de/aacp_96
  Radio Swiss Jazz,http://stream.srg-ssr.ch/m/rsj/aacp_96
  Radio X London,http://media-sov.musicradio.com:80/RadioXLondonMP3
  San Diego Jazz 88.3,http://listen.jazz88.org/ksds.mp3
"

# Optionally Get station name from CLI
chosen="${1:-}"

if [[ -z "$chosen" ]]; then
  chosen="$(sed -E 's/^\s+//;s/,.*$//;/^\s*$/d' <<< "$streams" | dmenu -p "radio:" -l 9 -g 6)"
  if [[ -z "$chosen" ]] || [[ "$chosen" =~ --- ]]; then
    exit
  fi
fi

systemctl --user stop "$unit_name" || true
if [[ "$chosen" =~ Stop ]]; then
  exit
fi

if [[ "$chosen" =~ Random ]]; then
  readonly names_only="$(sed -E 's/^\s+//;s/,.*$//;/^\s*\W/d' <<< "$streams")"
  chosen="$(shuf -n 1 <<< "$names_only")"
fi

dunstify -r $notify_id -t "$notify_time" -i "$notify_icon" "dmenu_radio" "Playing $chosen..."
readonly url="$(printf "%s" "$streams" | grep -m 1 "$chosen" | cut -d, -f 2-)"
systemd-run \
  --user \
  --collect \
  --unit "$unit_name" \
  --description "$chosen" \
  mpv --no-video --no-resume-playback --shuffle "$url"
